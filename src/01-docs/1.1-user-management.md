# 1.1 User Management – Implementation Notes

This note elaborates Requirement **1.1 User Management** and documents how the NestJS backend fulfills (or plans to fulfill) each bullet. Pair it with `src/01-docs/1-core-features.md` for a high-level summary.

---

## 1.1.0 Requirement → Implementation map

| Requirement bullet | Current status |
| --- | --- |
| Sign up / Sign in (Email, Phone, Social login) | ✅ Email-based signup/signin provided via GraphQL mutations. Phone/Social login are not yet implemented. |
| OTP verification for phone numbers | ⏳ Not implemented. Placeholder fields (`isConfirmed`) support future flows. |
| Email verification | ⏳ Not implemented. Can leverage `isConfirmed` + email service integrations. |
| Password reset | ⏳ Not implemented. Needs token issuance + email delivery. |
| Profile management (name, photo, preferences) | ✅ Names handled in `CreateUserInput`; photo/preferences pending. |
| Account deletion/deactivation | ✅ `deleteAccount` mutation performs soft delete so accounts can be restored. |

---

## 1.1.1 Data model

File: `src/user/entities/user.entity.ts`

- **Primary keys**: UUID (`id`).
- **Identity fields**: `email`, `firstName`, `lastName`, `password` (hashed).
- **Status fields**:
  - `isConfirmed` (default true for MVP).
  - `isActive` (supports future manual deactivation).
  - `deletedAt` soft-delete column.
- **Timestamps**: `createdAt`, `updatedAt`.
- **Relations**: `bookings` one-to-many to `RideBooking` so we can fetch passenger history.

---

## 1.1.2 GraphQL contracts

Defined in:
- `src/user/user.resolver.ts`
- `src/schema.gql`
- Sample calls: `src/02-Query/user.graphql`

Available operations:

1. `signup(createUserInput: CreateUserInput!) → User`
   - Required fields: `email`, `firstName`, `lastName`, `password`.
   - Returns the created user (sans password) with timestamps & status flags.
2. `signin(loginInput: LoginInput!) → AuthResponse`
   - Validates credentials, returns `{ accessToken, user }`.
   - Access token is JWT signed via `@nestjs/jwt` with 7-day expiry.
3. `me` / `users` / `user(id: String!)`
   - All behind `JwtAuthGuard`; use the decoded JWT payload (`context.req.user`) to fetch passenger data.
4. `deleteAccount`
   - Soft deletes the authenticated user.

Headers for protected queries:
```
Authorization: Bearer <access-token>
```

---

## 1.1.3 Service logic highlights

File: `src/user/user.service.ts`

- **Signup**:
  - Checks for existing email (including soft-deleted rows). If found + deleted, it restores the user instead of creating duplicates.
  - Password hashing via `bcrypt` with 10 salt rounds.
  - Initializes `isConfirmed` + `isActive` as true.
- **Signin**:
  - Validates user presence, `isActive`, and password hash.
  - Uses `JwtService` to sign `{ sub: user.id, email: user.email }`.
  - Removes the password before returning the user object.
- **Deletion**:
  - `softDelete` retains data for future restoration or auditing.
- **Queries**:
  - `findOne`, `findAll`, and `findByEmail` shield against soft-deleted rows.

---

## 1.1.4 Authentication stack

- `src/auth/auth.module.ts` wires `PassportModule`, JWT config, and `UserModule`.
- `src/auth/strategies/jwt.strategy.ts`:
  - Extracts the Bearer token.
  - Validates JWT signature.
  - Loads the user from the database and rejects inactive accounts.
- `src/auth/guards/jwt-auth.guard.ts` adapts Passport’s request extraction for GraphQL (`GqlExecutionContext`).

---

## 1.1.5 Testing checklist

1. Run `signup` with a fresh email; confirm response includes `id`, timestamps, and `isConfirmed = true`.
2. Run `signin` with the same credentials; store the returned `accessToken`.
3. Call `me`, `users`, and `user(id)` using the Authorization header.
4. Call `deleteAccount` and then ensure `signin` now fails with `Invalid credentials`.
5. Re-run `signup` with the original email; verify the soft-deleted account is reactivated instead of creating a duplicate ID.

---

## 1.1.6 Future enhancements

- **OTP / MFA**: Integrate Twilio (SMS) or email OTP for `signin`/`signup` confirmation.
- **Social login**: Add OAuth providers (Google, Apple) with a `provider` column + token exchange flow.
- **Password reset**: Implement a token table + email templates under `src/auth`.
- **Profile enrichment**: Extend the `User` entity with avatar URL, phone number, saved preferences.
- **Rate limiting**: Add throttling middleware around auth endpoints to mitigate brute force attacks.

Document updates should accompany feature work to keep Requirement §1.1 aligned with what the backend actually delivers.


